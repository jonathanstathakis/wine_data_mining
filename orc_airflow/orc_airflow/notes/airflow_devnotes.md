# Airflow Development Notes

## Nesting Code

Code specific to a DAG should be defined as nested within the DAG definition when possible to avoid re-execution every time the DAG is parsed.

## Minimise Number of DAGs per File

Spreading the DAGs out over multiple files is more efficient.

## Testing

1. Loader Test: run `python <dag_file>.py` to observe whether the files are interpreted properly.
2. Unit Tests: Use pytest and the DagBag model: see [link](https://airflow.apache.org/docs/apache-airflow/stable/best-practices.html#unit-tests). Typical tests include `assert dagbag.import_erors == {}`, `assert dag is not None`, `assert len(dag.tasks)`, etc.
3. self checks: integrate checks as tasks in sequence, for example validating the data generated by a previous

## Using Duckdb with Airflow

2025-07-10T00:21

Defining a duckdb connection through Airflow UI then using the duckdb_providor.hooks.duckdb_hook.DuckDBHook.get_hook to get the defined connection is the best way to use duckdb. This way the connection is standardised and you can change the connection id in tests.

### Sources

- <https://www.astronomer.io/docs/learn/airflow-duckdb/>

## Dadbod - SQL - Airflow Development Flow

2025-07-10T11:50

To develop new queries we can simply use dadbod directly on the database connection then add the query to a dag once its ready. Can use SQL Operators for managing the execution of the sql files. Now that we understand how that works there is really no justification for keeping the individual pipelines in separate modules.

## Setting up Database Connections

2025-07-10T12:24

Quickest way to set a database connection is to use `airflow connections add <conn_id> --conn-uri=<path>`. To automate this we can store the command in a python file that is executed on setup. The docs advise using Airflow UI but there's no obvious way to add a relative path from project root, as the UI implements paths from absolute root. Technically speaking it doesnt matter where the database is for a local project as long as the connection is used, but for re-usability you'd need to setup a make script using the command above with path relative to project root, i.e. using BASE_DIR.
